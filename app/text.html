<!DOCTYPE html>
<html>
<head>
  <title></title>
  <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/jquery/1.10.2/jquery.min.js" ></script>
  <script type="text/javascript">
    /**
     * jQuery.ajax mid - CROSS DOMAIN AJAX
     * ---
     * @author James Padolsey (http://james.padolsey.com)
     * @version 0.11
     * @updated 12-JAN-10
     * ---
     * Note: Read the README!
     * ---
     * @info http://james.padolsey.com/javascript/cross-domain-requests-with-jquery/
     */

    jQuery.ajax = (function(_ajax){

      var protocol = location.protocol,
          hostname = location.hostname,
          exRegex = RegExp(protocol + '//' + hostname),
          YQL = 'http' + (/^https/.test(protocol)?'s':'') + '://query.yahooapis.com/v1/public/yql?callback=?',
          query = 'select * from html where url="{URL}" and xpath="*"';


      function isExternal(url) {
        return !exRegex.test(url) && /:\/\//.test(url);
      }

      return function(o) {

        var url = o.url;

        if ( /get/i.test(o.type) && !/json/i.test(o.dataType) && isExternal(url) ) {

          // Manipulate options so that JSONP-x request is made to YQL

          o.url = YQL;
          o.dataType = 'json';

          o.data = {
            q: query.replace(
                '{URL}',
                url + (o.data ?
                    (/\?/.test(url) ? '&' : '?') + jQuery.param(o.data)
                    : '')
            ),
            format: 'json'
          };

          // Since it's a JSONP request
          // complete === success
          if (!o.success && o.complete) {
            o.success = o.complete;
            delete o.complete;
          }

          o.success = (function(_success){
            return function(data) {

              if (_success) {
                // Fake XHR callback.
                _success.call(this, {
                  responseText: (data || '')
                }, 'success');
              }

            };
          })(o.success);

        }

        return _ajax.apply(this, arguments);

      };

    })(jQuery.ajax);

  </script>
</head>
<body>

<script type="text/javascript">
  var providers = {
    mtgox : {
      symbol : 'mtgox',
      url : 'https://data.mtgox.com/api/2/BTCUSD/money/ticker_fast'
    },

    btce : {
      symbol: 'btc-e',
      url : 'https://btc-e.com/api/2/btc_usd/ticker'
    }
  };

  var sync = {
    /**
     * Recoger Valores Iniciales
     */
    init : function (){
      //Register event to save data
      this.register();

      for (var key in providers){
        if (providers.hasOwnProperty(key)){
          this.update(key);
        }
      }
    },

    update : function (provider){
      var currentProvider = {};
      if (providers[provider] === undefined) {
        return false;
      }else {
        currentProvider = providers[provider];
      }

      $.ajax({
        url: currentProvider.url,
        type: 'GET',
        success: function(data) {
          //Lanzo el trigger
          var jsonTicker = {};
          if (data && data.responseText.query !== undefined){
            try {
              jsonTicker = JSON.parse(data.responseText.query.results.html.body.p);
            }catch (Exception) {
              jsonTicker = {};
            }
          }

          $('body').trigger('btc-update-provider', [jsonTicker, currentProvider.symbol]);
        }
      });
    },

    register : function () {
      $('body').on('btc-update-provider', function(event,data,symbol){
        console.log(symbol + " ----> " + data);
      });
    }
  };

  $(document).ready(function(){
    sync.init();
  })


</script>

</body>
</html>